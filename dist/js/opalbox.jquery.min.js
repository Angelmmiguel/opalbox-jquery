/*
 * Generate an HTML box to write ruby code an execute it on output.
 * This plugin uses http://opalrb.org/ to compile the Ruby code into
 * javascript.
 *
 * @author Angel M (@laux_es)
 * @version 1.0.0
 * @license MIT License
 */
!function($,window,document,undefined){function OpalBox(e,t){this.element=e,this._name=pluginName,this.requirements=!1,this._defaults=$.fn.opalBox.defaults,this.options=$.extend({},this._defaults,t),this.init()}var pluginName="opalBox";$.extend(OpalBox.prototype,{init:function(){this._initOpal(),this._createBox(),this._buildCache(),this._bindEvents()},destroy:function(){this._unbindEvents(),this.$element.removeData()},_initOpal:function(){"object"!=typeof Opal||"function"!=typeof Opal.modules["opal-parser"]?this._notLoadedError():(this.requirements=!0,Opal.load("opal-parser"))},_createBox:function(){this.$element=$(this.element),this.code=this.$element.text(),this.$element.addClass(this.options.theme+" opbox"),this.$element.html(""),this.$element.append(this._baseHTML())},_baseHTML:function(){return'<div class="opbox-header">'+this.options.title+'</div><div class="opbox-code-wrap"><textarea class="opbox-code">'+this.code+'</textarea></div><div class="opbox-output"><div class="opbox-execute"><button class="opbox-run">Run</button><div class="opbox-loader"></div><div class="opbox-loader delayed"></div></div><div class="opbox-result"><p class="empty">'+this.options.result+"</p></div></div>"},_buildCache:function(){this.$execute=this.$element.find(".opbox-run"),this.$loader=this.$element.find(".opbox-loader"),this.$code=this.$element.find(".opbox-code"),this.$result=this.$element.find(".opbox-result"),this.standardLog=window.console.log},_bindEvents:function(){var e=this;e.$execute.on("click."+e._name,function(){e.execute.call(e)}),e.options.autoadjust&&(e.$code.on("input",function(){$(this).height(this.scrollHeight-25)}),e.$code.trigger("input"))},_notLoadedError:function(){console.warn("Required Opal libraries are not loaded")},unbindEvents:function(){this.$execute.off("."+this._name)},compile:function(){return Opal.compile(this.$code.val())},execute:function(){if(!this.requirements)return this._notLoadedError(),void this.$result.html("<p class='empty'>Libraries are not loaded.<p>");this._setButtonLoading();var compiled=this.compile(),error,res;this.$result.html("");try{var self=this;window.console.log=function(e){self._showResult(e)},res=eval(compiled)}catch(compiled_error){error=compiled_error.message}window.console.log=this.standardLog,error===undefined?this._showResult(res):this._showResult(error,!0),this._setButtonRun(),this.callback()},_setButtonLoading:function(){this.$execute.html("&nbsp;"),this.$loader.show()},_setButtonRun:function(){this.$loader.hide(),this.$execute.html("Run")},_showResult:function(e,t){t===!0?this.$result.append("<p class='opbox-error'>"+e+"</p>"):this.$result.append("<p>"+e+"</p>")},callback:function(){var e=this.options.onComplete;"function"==typeof e&&e.call(this.element)}}),$.fn.opalBox=function(e){return this.each(function(){$.data(this,"plugin_"+pluginName)||$.data(this,"plugin_"+pluginName,new OpalBox(this,e))}),this},$.fn.opalBox.defaults={theme:"light",onComplete:null,title:"Ruby code",result:"Result will appear here",autoadjust:!1}}(jQuery,window,document);